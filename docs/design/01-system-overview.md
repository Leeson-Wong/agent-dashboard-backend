# Agent Dashboard 系统架构总览

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档类型** | 系统架构总览 (入口文档) |
| **创建时间** | 2025-02-07 |
| **状态** | 活跃维护 |
| **适用对象** | 架构师、开发者、技术决策者 |

---

## 1. 项目定位

### 1.1 项目愿景

**构建一个云端 Agent 编排与管理平台，实现多 Agent 的全生命周期管理。**

```
┌─────────────────────────────────────────────────────────────────┐
│                      项目定位                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  不仅仅是一个监控工具，而是一个完整的 Agent 管理平台：              │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  核心能力                                                │    │
│  │  ├─ Agent 生命周期管理 (创建、配置、部署、监控、销毁)        │    │
│  │  ├─ 任务调度系统 (分配、执行、追踪)                         │    │
│  │  ├─ 技能与模板管理 (动态分配、版本控制)                       │    │
│  │  ├─ 资源管理 (Memory、API Key、配额)                         │    │
│  │  └─ 多租户支持 (组织、用户、权限)                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  与传统监控工具的区别:                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  传统监控工具              │  │  Agent Dashboard            │    │
│  │  ├─ 只能查看状态            │  │  ├─ 控制生命周期               │    │
│  │  ├─ 被动接收事件            │  │  ├─ 主动调度任务               │    │
│  │  └─ 单向信息流              │  │  ├─ 管理资源分配               │    │
│  │                             │  │  └─ 多租户隔离                 │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 核心价值主张

| 价值 | 说明 |
|------|------|
| **全生命周期管理** | 从创建到销毁的完整 Agent 管理 |
| **智能任务调度** | 根据能力和负载自动分配任务 |
| **灵活资源管理** | Memory、Skill、API Key 动态分配 |
| **实时状态同步** | WebSocket + 快照+增量的高效同步 |
| **多租户隔离** | 组织级别的资源隔离和权限控制 |

---

## 2. 核心设计原则

### 2.1 Memory-First 理念

**核心思想：Agent 是朝生暮死的容器，Memory 才是本体**

```
┌─────────────────────────────────────────────────────────────────┐
│                     Memory-First 理念                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  传统范式:                                                     │
│    Agent 是主体，Memory 是附属                               │
│    └─ 问题：Agent 挂掉，状态丢失                              │
│                                                                  │
│  新范式:                                                       │
│    Memory 是本体，Agent 是临时容器                             │
│    └─ 优势：状态持久化，Agent 可随时重建                     │
│                                                                  │
│  设计原则:                                                     │
│    ┌─────────────────────────────────────────────────────────┐ │
│    │  1. Memory = 真实的 AI                                  │ │
│    │     • 记得过去 (经验、知识)                              │ │
│    │     • 知道现在 (当前任务、上下文)                         │ │
│    │     • 理解时间 (模型时间 vs 真实世界)                       │ │
│    │     • 知道自己 (身份、角色、人格)                         │ │
│    │                                                      │ │
│    │  2. Agent = 执行容器 (朝生暮死)                           │ │
│    │     • 按需创建，用完即销毁                                  │ │
│    │     • 无状态，所有状态存在 Memory                        │ │
│    │     • 可以同时存在多个 Agent 容器服务同一个 Memory       │ │
│    │                                                      │ │
│    │  3. 思考与执行分离                                        │ │
│    │     • 思考节点：GPU 密集，负责 LLM 推理                   │ │
│    │     • 执行节点：IO 密集，负责代码执行                     │ │
│    │     • 一对多：一个思考节点可以服务多个执行节点             │ │
│    │     • 可合并：资源受限时可以在同一节点                     │ │
│    └─────────────────────────────────────────────────────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 技术选型原则

| 原则 | 说明 |
|------|------|
| **成熟优先** | 不使用维护状态不明确的项目（如 OpenInterpreter） |
| **抽象优先** | 定义接口，不依赖具体实现，便于替换 |
| **渐进式演进** | 从简单到复杂，分阶段实现 |
| **成本优化** | 根据 SLA 级别选择合适的资源配置 |

---

## 3. 系统架构

### 3.1 总体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    Agent Dashboard 架构                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                        前端层                            │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │    │
│  │  │   Web UI     │  │   3D 可视化   │  │   移动 App    │    │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘    │    │
│  └────────────────────────────┬────────────────────────────────┘    │
│                            ↓ HTTPS/WebSocket                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                      API 网关                              │    │
│  │  • 认证/授权                                               │    │
│  │  • 限流/负载均衡                                            │    │
│  │  • WebSocket 管理                                          │    │
│  └────────────────────────────┬────────────────────────────────┘    │
│                            ↓                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    核心服务层                             │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │    │
│  │  │ Memory Service│  │ Agent Service│  │  Task Service │  │    │
│  │  │  • 本体管理   │  │  • 生命周期  │  │  • 调度执行   │  │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │    │
│  │  │Template Service│  │ Skill Service│  │Quota Service │  │    │
│  │  │  • 模板管理   │  │  • 技能库     │  │  • 配额限制   │  │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  │    │
│  └────────────────────────────┬────────────────────────────────┘    │
│                            ↓                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   消息队列/事件总线                        │    │
│  │  • 任务队列                                               │    │
│  │  • 状态同步                                               │    │
│  │  • WebSocket 推送                                         │    │
│  └────────────────────────────┬────────────────────────────────┘    │
│                            ↓                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    执行层                                 │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │  思考节点 (Reasoning Nodes)                         │    │    │
│  │  │  • LLM 推理服务 (vLLM/Ollama/第三方 API)              │    │    │
│  │  │  • GPU 密集                                              │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │  执行节点 (Execution Nodes)                         │    │    │
│  │  │  • Docker 容器池                                       │    │    │
│  │  │  • 本地执行环境                                          │    │    │
│  │  │  • 高权限隔离                                            │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 部署架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    部署模式                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  云端部署 (资源充足)                                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  思考节点集群               │    │    │
│  │    ↓ 一对多                  │    │    │
│  │  执行节点池 1-N │    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  本地部署 (资源受限)                                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  混合节点 (思考 + 执行合二为一)                           │    │
│  │  • 本地 LLM (Ollama)                                      │    │
│  │  • 本地执行环境 (Docker/Process)                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  边缘/移动部署 (轻量级)                                           │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  移动设备 / 边缘节点                                      │    │
│  │  • 云端 API 思考                                            │    │
│  │  • 本地受限执行                                            │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 核心模块

### 4.1 模块划分

```
┌─────────────────────────────────────────────────────────────────┐
│                    模块架构                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Memory 模块                   │    │
│  │  • 核心: Memory 是 AI 本体                               │    │
│  │  • 功能: 身份管理、经验提取、知识更新、时间补丁          │    │
│  │  • 文档: [04-memory-management.md](./04-memory-management.md) │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Agent 模块                   │    │
│  │  • 核心: Agent = Memory + Model + Skills (运行时组合)      │    │
│  │  • 功能: 生命周期管理、状态同步、资源分配                │    │
│  │  • 文档: [03-memory-first-architecture.md](./03-memory-first-architecture.md) │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  同步模块                     │    │
│  │  • 核心: 快照 + 增量数据同步                              │    │
│  │  • 功能: WebSocket 推送、断线重连、状态一致性          │    │
│  │  • 文档: [02-snapshot-delta-sync.md](./02-snapshot-delta-sync.md) │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  任务调度模块                 │    │
│  │  • 核心: 智能分配任务到合适的 Agent                        │    │
│  │  • 功能: 任务队列、优先级、资源调度、执行追踪            │    │
│  │  • 状态: 待设计                                            │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  模板管理模块                 │    │
│  │  • 核心: Agent 配置模板                                    │    │
│  │  • 功能: 模板版本控制、快速部署、配置继承                │    │
│  │  • 状态: 待设计                                            │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  技能管理模块                  │    │
│  │  • 核心: 技能库管理                                        │    │
│  │  • 功能: 技能定义、熟练度追踪、动态分配                   │    │
│  │  • 状态: 待设计                                            │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  执行层抽象                   │    │
│  │  • 核心: 统一的执行接口                                    │    │
│  │  • 功能: 支持多种 Runtime (Docker, Process, Firecracker)  │    │
│  │  • 文档: [03-memory-first-architecture.md](./03-memory-first-architecture.md#6-容器技术选型) │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 技术栈

### 5.1 后端技术栈

| 层级 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **语言** | Java | 17 | 主要开发语言 |
| **框架** | Spring Boot | 3.2.0 | 应用框架 |
| **持久层** | MyBatis | 3.0.3 | ORM |
| **数据库** | MySQL | 8.0+ | 主要数据存储 |
| **数据库版本管理** | Liquibase | - | 数据库迁移 |
| **连接池** | Druid | 1.2.20 | 数据库连接池 |
| **实时通信** | WebSocket | - | 实时推送 |
| **构建工具** | Maven | - | 项目构建 |

### 5.2 前端技术栈

| 层级 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **语言** | TypeScript | 5.6+ | 开发语言 |
| **框架** | Vite | 6.0+ | 构建工具 |
| **3D 渲染** | Three.js | 0.170.0 | 3D 可视化 |
| **构建工具** | npm/pnpm | - | 包管理 |

### 5.3 执行层技术栈

| 技术 | 状态 | 用途 |
|------|------|------|
| **Docker** | ✅ 推荐 | 通用执行环境（成熟、稳定） |
| **Process Pool** | ✅ 推荐 | 简单任务（轻量、快速） |
| **E2B** | ✅ 备选 | AI 代码执行（企业级） |
| **Firecracker** | ✅ 扩展 | 高安全隔离（微虚拟机） |
| **OpenInterpreter** | ❌ 不推荐 | 维护状态不明确 |

### 5.4 思考层技术栈

| 技术 | 状态 | 用途 |
|------|------|------|
| **OpenAI API** | ✅ 推荐 | 高质量推理 |
| **Anthropic API** | ✅ 推荐 | 长上下文推理 |
| **Ollama** | ✅ 推荐 | 本地部署（隐私） |
| **vLLM** | ✅ 扩展 | 高吞吐推理 |

---

## 6. 数据流

### 6.1 数据同步流

```
┌─────────────────────────────────────────────────────────────────┐
│                    数据同步流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  初始加载:                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  1. 前端启动 → API: GET /api/snapshot/latest           │    │
│  │  2. 获取快照 (所有 Agent 当前状态)                         │    │
│  │  3. → API: GET /api/events?since=<snapshotSeq>          │    │
│  │  4. 获取快照后的增量事件                                 │    │
│  │  5. 应用到本地状态                                         │    │
│  │  6. 连接 WebSocket → 开始接收实时推送                    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  实时更新:                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Agent 状态变化 → 后端事件处理 → WebSocket 推送         │    │
│  │  → 前端接收 → 更新 UI 和 3D 场景                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  断线重连:                                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  1. WebSocket 断开 → 自动重连 (3秒间隔)                   │    │
│  │  2. 重连成功 → GET /api/events?since=<lastSeq>            │    │
│  │  3. 如果 seq 过期 → 回退到完整同步 (获取新快照)            │    │
│  │  4. 恢复状态                                               │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 任务执行流

```
┌─────────────────────────────────────────────────────────────────┐
│                    任务执行流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 用户提交任务                                               │
│     │                                                             │
│     ↓                                                             │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Task Service                                             │    │
│  │  ├─ 分析任务需求                                           │    │
│  │  ├─ 检查 Memory 状态                                       │    │
│  │  └─ 决定执行策略                                           │    │
│  └────────────────────┬────────────────────────────────────┘    │
│                        ↓                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  激活 Memory                                             │    │
│  │  ├─ 携带策略: 携带哪些记忆？                               │    │
│  │  ├─ Token 预算: 估算 token 需求                             │    │
│  │  └─ 加载 Memory (从存储)                                  │    │
│  └────────────────────┬────────────────────────────────────┘    │
│                        ↓                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  思考层                                                 │    │
│  │  ├─ LLM 推理 (消耗 token)                                   │    │
│  │  ├─ 规划任务步骤                                           │    │
│  │  └─ 生成执行指令                                           │    │
│  └────────────────────┬────────────────────────────────────┘    │
│                        ↓ 指令                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  执行层                         │    │
│  │  ├─ 申请执行资源 (Docker/Process)                         │    │
│  │  ├─ 执行代码/命令                                          │    │
│  │  └─ 返回结果                                               │    │
│  └────────────────────┬────────────────────────────────────┘    │
│                        ↓ 结果                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Memory 更新                                             │    │
│  │  ├─ 提取经验 (如果任务成功)                                 │    │
│  │  ├─ 更新知识 (从对话中学习)                                 │    │
│  │  ├─ 记录状态变化                                            │    │
│  │  └─ 清理工作记忆                                           │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 设计文档索引

| 编号 | 文档 | 状态 | 说明 |
|------|------|------|------|
| 01 | **系统架构总览** (本文档) | ✅ 已完成 | 项目定位、架构概览、技术栈 |
| 02 | [WebSocket 实时同步设计](./02-snapshot-delta-sync.md) | ✅ 已完成 | 快照+增量数据同步方案 |
| 03 | [Memory-First 架构设计](./03-memory-first-architecture.md) | ✅ 已完成 | Memory 优先、思考-执行分离 |
| 04 | [Memory 管理系统](./04-memory-management.md) | ✅ 已完成 | Memory 作为 AI 本体的管理 |

---

## 8. 实施路线图

```
┌─────────────────────────────────────────────────────────────────┐
│                    实施路线图                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  阶段 1: MVP (1-2 个月)                                       │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  目标: 验证核心概念                                       │    │
│  │  └─────────────────────────────────────────────────────────┘    │
│  ├─ 基础 Memory 管理 (身份、短期记忆)                        │    │
│  ├─ 简单 Agent 创建 (手动配置)                               │    │
│  ├─ REST API 通信                                           │    │
│  ├─ 前端 3D 可视化 (基础)                                   │    │
│  └─ 进程级执行环境                                         │    │
│                                                                  │
│  阶段 2: Beta (3-6个月)                                        │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  目标: 生产可用                                           │    │
│  │  └─────────────────────────────────────────────────────────┘    │
│  ├─ 完整 Memory 管理 (长期记忆、经验、知识)                     │    │
│  ├─ Docker 执行层                                         │    │
│  ├─ WebSocket 实时推送                                     │    │
│  ├─ 任务调度系统                                           │    │
│  └─ 多租户支持                                             │    │
│                                                                  │
│  阶段 3: Production (6-12个月)                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  目标: 大规模支持                                         │    │
│  │  └─────────────────────────────────────────────────────────┘    │
│  ├─ 思考-执行分离部署                                      │    │
│  ├─ 经验自动提取                                         │    │
│  ├─ 智能资源调度                                           │    │
│  └─ 高可用部署                                             │    │
│                                                                  │
│  阶段 4: Scale (持续迭代)                                       │
│  ├─ 时间补丁自动生成                                       │    │
│  ├─ Agent 自我学习                                         │    │
│  └─ 跨云部署                                               │    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. 非功能性需求

### 9.1 安全性

| 需求 | 说明 |
|------|------|
| **多租户隔离** | 组织级别的资源隔离 |
| **API Key 管理** | 加密存储，审计日志 |
| **执行沙箱** | Docker 容器隔离，防止逃逸 |
| **权限控制** | RBAC 权限模型 |

### 9.2 可靠性

| 需求 | 目标 |
|------|------|
| **高可用** | 99.9% 可用性 |
| **数据持久化** | Memory 数据零丢失 |
| **断线恢复** | 自动重连，状态恢复 |
| **容错** | 节点故障自动转移 |

### 9.3 可扩展性

| 需求 | 目标 |
|------|------|
| **水平扩展** | 支持 1000+ 并发 Agent |
| **垂直扩展** | GPU 集群可独立扩展 |
| **地理分布** | 支持多区域部署 |

### 9.4 成本优化

| 策略 | 说明 |
|------|------|
| **容器池化** | 复用容器，减少启动开销 |
| **Token 优化** | 智能压缩，减少 API 调用成本 |
| **资源调度** | 根据负载动态分配资源 |
| **冷热分离** | 不常用的 Agent 冷存储 |

---

## 10. 附录

### 10.1 术语表

| 术语 | 说明 |
|------|------|
| **Memory** | AI 的本体，包含身份、经验、知识等 |
| **Agent** | 临时执行容器，按需创建和销毁 |
| **思考节点** | 负责 LLM 推理的节点，GPU 密集 |
| **执行节点** | 负责代码执行的节点，IO 密集 |
| **时间补丁** | 更新模型过时知识的机制 |

### 10.2 相关链接

- [项目 README](../README.md)
- [数据库初始化脚本](../src/main/resources/db/init.sql)
- [应用配置](../src/main/resources/application.yml)

---

**文档维护**: 本文档是架构总览，随着项目演进持续更新。
**更新频率**: 每个阶段结束后更新一次。
